import{a9 as e,s,N as t,Q as i,P as n,a1 as o,L as r,a2 as a,ab as u,y as l,x as d}from"./index-CIWIA-pi.js";import{V as c,p as g}from"./uni-cloud.es.B_W3E-Ew.js";const p={debug:!1,isAdmin:!1,loginTypes:["weixin","username","smsCode"],agreements:{serviceUrl:"https://xxx",privacyUrl:"https://xxx",scope:["register","login","realNameVerify"]},appid:{weixin:{h5:"xxxxxx",web:"xxxxxx"}},passwordStrength:"",setPasswordAfterLogin:!1},f=c.importObject("uni-id-co"),x=c.database().collection("uni-id-users");let h=e("uni-id-pages-userInfo")||{};c.getCurrentUserInfo().tokenExpired-Date.now()<=0&&(h={});const m={async updateUserInfo(e=!1){if(e)x.where("_id==$env.uid").update(e).then((s=>{s.result.updated?(t({title:"更新成功",icon:"none",duration:3e3}),this.setUserInfo(e)):t({title:"没有改变",icon:"none",duration:3e3})}));else{const e=c.importObject("uni-id-co",{customUI:!0});try{let s=await x.where("'_id' == $cloudEnv_uid").field("mobile,nickname,username,email,avatar_file,register_date").get();const t=await e.getRealNameInfo();this.setUserInfo({...s.result.data[0],realNameAuth:t})}catch(s){this.setUserInfo({},{cover:!0}),console.error(s.message,s.errCode)}}},async setUserInfo(e,{cover:s}={cover:!1}){let t=s?e:Object.assign(w.userInfo,e);return w.userInfo=Object.assign({},t),w.hasLogin=0!=Object.keys(w.userInfo).length,i("uni-id-pages-userInfo",w.userInfo),e},async logout(){if(c.getCurrentUserInfo().tokenExpired>Date.now())try{await f.logout()}catch(e){console.error(e)}n("uni_id_token"),i("uni_id_token_expired",0),o("uni-id-pages-logout"),this.setUserInfo({},{cover:!0})},loginBack(e={}){const{uniIdRedirectUrl:s=""}=e;let t=0,i=r();if(i.forEach(((e,s)=>{"login"==i[i.length-s-1].route.split("/")[3]&&t++})),s)return a({url:s,fail:e=>{u({url:s,fail:s=>{console.log(e,s)}})}});if("weixin"==e.loginType)return window.history.go(-3);if(t){const e=g.pages[0];return l({url:`/${e.path}`})}d({delta:t})},loginSuccess(e={}){const{showToast:s=!0,toastText:i="登录成功",autoBack:n=!0,uniIdRedirectUrl:r="",passwordConfirmed:u}=e;if(s&&t({title:i,icon:"none",duration:3e3}),this.updateUserInfo(),o("uni-id-pages-login-success"),p.setPasswordAfterLogin&&!u)return a({url:r?`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?uniIdRedirectUrl=${r}&loginType=${e.loginType}`:`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?loginType=${e.loginType}`,fail:e=>{console.log(e)}});n&&this.loginBack({uniIdRedirectUrl:r})}},w=s({userInfo:h,hasLogin:0!=Object.keys(h).length});export{p as c,m,w as s};
